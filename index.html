<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E-Gerak PPD Ranau</title>
    
    <!-- PWA MANIFEST LINK (Placeholder - requires hosting) -->
    <link rel="manifest" href="manifest.json">
    
    <!-- PWA ICONS -->
    <link rel="apple-touch-icon" sizes="152x152" href="icon-152.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="152x152" href="icon-152.png">
    <link rel="shortcut icon" href="icon-152.png">
    
    <!-- MOBILE THEME COLORS -->
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="E-Gerak">
    
    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- FIREBASE COMPAT SDKs (Used for structure, but logic is client-side state) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        @media print { .no-print { display: none !important; } }
        body { -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        /* Hide scrollbar for clean mobile look */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        /* Green Dot Pulse Animation */
        @keyframes pulse-green {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(74, 222, 128, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        .online-dot {
            width: 10px;
            height: 10px;
            background-color: #22c55e;
            border-radius: 50%;
            animation: pulse-green 2s infinite;
        }
        /* Custom Scrollbar for Select */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 select-none">
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. KONFIGURASI FIREBASE (Simulated) ---
        // NOTE: In a real app, __firebase_config and __initial_auth_token would be used here.
        const firebaseConfig = {
            apiKey: "AIzaSyBU1n6OAmYxY_SjFuhYkop7C7CrFJja6Do",
            authDomain: "egerak-4f922.firebaseapp.com",
            projectId: "egerak-4f922",
            storageBucket: "egerak-4f922.firebasestorage.app",
            messagingSenderId: "567427021114",
            appId: "1:567427021114:web:cf5496d2fc14eb84893803",
            measurementId: "G-V6CGGJ81JG"
        };

        if (!firebase.apps.length) {
            try {
                firebase.initializeApp(firebaseConfig);
            } catch (e) {
                console.error("Ralat Firebase:", e);
            }
        }
        
        const db = firebase.apps.length ? firebase.firestore() : null;
        const auth = firebase.apps.length ? firebase.auth() : null;

        const { useState, useEffect, useMemo, useRef } = React;

        // --- 2. DATA LALAI (Simulated In-Memory Data) ---
        const CURRENT_YEAR = new Date().getFullYear();
        const INITIAL_DATA = {
            users: [
                { id: '1', username: 'shell', password: 'shellyap', role: 'admin', name: 'Shell Yap', department: 'IT / Pengurusan', lastSeen: new Date(Date.now() - 1000) },
                { id: '2', username: 'staff', password: '123', role: 'staff', name: 'En. Razak', department: 'Unit Pembangunan', lastSeen: new Date(Date.now() - 30000) },
                { id: '3', username: 'nona', password: '456', role: 'staff', name: 'Pn. Nona', department: 'Unit Kewangan', lastSeen: new Date(Date.now() - 600000) }
            ],
            logs: [
                { id: 'l1', userId: '2', userName: 'En. Razak', date: '2025-12-03', location: 'SK Pekan Ranau', type: 'Lawatan Bimbingan', catatan: 'Pemantauan pengurusan aset sekolah.', createdAt: new Date(Date.now() - 3600000) },
                { id: 'l2', userId: '2', userName: 'En. Razak', date: '2025-12-02', location: 'SMK Ranau', type: 'Mesyuarat', catatan: 'Mesyuarat Penyelarasan Projek Pembangunan.', createdAt: new Date(Date.now() - 86400000) },
                { id: 'l3', userId: '1', userName: 'Shell Yap', date: '2025-11-28', location: 'PPD Ranau', type: 'Mesyuarat', catatan: 'Mesyuarat IT Mingguan.', createdAt: new Date(Date.now() - 5 * 86400000) }
            ],
            locations: [
                {id: '1', name: 'PPD Ranau', category: 'Lain-Lain Tempat'}, 
                {id: '2', name: 'SK Pekan Ranau', category: 'Sekolah Rendah'},
                {id: '3', name: 'SMK Ranau', category: 'Sekolah Menengah'},
                {id: '4', name: 'SK Kilimu', category: 'Sekolah Rendah'},
                {id: '5', name: 'SMK Kundasang', category: 'Sekolah Menengah'}
            ],
            activityTypes: [{id: '1', name: 'Lawatan Bimbingan'}, {id: '2', name: 'Mesyuarat'}, {id: '3', name: 'Tugas Khas'}]
        };

        const LOCATION_CATEGORIES = ['Sekolah Rendah', 'Sekolah Menengah', 'Lain-Lain Tempat'];

        // --- 3. ICONS (Lucide Icons) ---
        const IconBase = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        
        const Icons = {
            MapPin: (p) => <IconBase {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>,
            User: (p) => <IconBase {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>,
            Lock: (p) => <IconBase {...p}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>,
            LogOut: (p) => <IconBase {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></IconBase>,
            Plus: (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>,
            Search: (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>,
            Filter: (p) => <IconBase {...p}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></IconBase>,
            FileText: (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></IconBase>,
            CheckCircle: (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>,
            Trash2: (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>,
            AlertCircle: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>,
            CalendarIcon: (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>,
            PieChart: (p) => <IconBase {...p}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></IconBase>,
            Settings: (p) => <IconBase {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>,
            Trophy: (p) => <IconBase {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 1 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconBase>,
            TrendingUp: (p) => <IconBase {...p}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconBase>,
            RefreshCw: (p) => <IconBase {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>,
            ListIcon: (p) => <IconBase {...p}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></IconBase>,
            Edit3: (p) => <IconBase {...p}><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></IconBase>,
            Info: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>,
            AlertTriangle: (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconBase>,
            Printer: (p) => <IconBase {...p}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></IconBase>,
            FileSpreadsheet: (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></IconBase>,
            Menu: (p) => <IconBase {...p}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></IconBase>,
            X: (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>,
            UsersIcon: (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>,
            Key: (p) => <IconBase {...p}><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/></IconBase>,
            ChevronDown: (p) => <IconBase {...p}><path d="m6 9 6 6 6-6"/></IconBase>
        };

        // --- 4. UTILS ---
        const isUserOnline = (lastSeen) => {
            if (!lastSeen) return false;
            const date = lastSeen.toDate ? lastSeen.toDate() : new Date(lastSeen);
            const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
            return date > fiveMinutesAgo;
        };
        const formatDate = (dateString) => {
            if (!dateString) return '-';
            const parts = dateString.split('-');
            if (parts.length !== 3) return dateString;
            const [year, month, day] = parts;
            return `${day}/${month}/${year.slice(-2)}`;
        };
        const downloadCSV = (data, filename) => {
            const headers = ["Tarikh", "Nama", "Tujuan", "Lokasi", "Catatan"];
            const rows = data.map(row => [
                formatDate(row.date),
                row.userName, 
                row.type, 
                row.location, 
                (row.catatan || '').replace(/,/g, ' ')
            ]);
            const csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...rows.map(e => e.join(","))].join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };


        // --- 5. COMPONENTS ---

        // (A) Popups/Modals
        const SuccessModal = ({ isOpen, onClose, message }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[150] p-4 fade-in">
                    <div className="bg-white rounded-xl max-w-sm w-full p-6 shadow-2xl transform scale-100 transition-transform">
                        <div className="text-center">
                            <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <Icons.CheckCircle className="w-8 h-8 text-green-600" />
                            </div>
                            <h3 className="text-xl font-bold text-slate-800 mb-2">Berjaya!</h3>
                            <p className="text-slate-600 mb-6">{message}</p>
                            <button onClick={onClose} className="w-full bg-blue-900 text-white py-2.5 rounded-lg font-semibold hover:bg-blue-800 transition-colors shadow-lg">Tutup</button>
                        </div>
                    </div>
                </div>
            );
        };
        const DeleteConfirmationModal = ({ isOpen, onClose, onConfirm, itemName }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[150] p-4 fade-in">
                    <div className="bg-white rounded-xl max-w-sm w-full p-6 shadow-2xl border-2 border-red-50 transform scale-100 transition-all">
                        <div className="text-center">
                            <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                                <Icons.AlertCircle className="w-8 h-8 text-red-600" />
                            </div>
                            <h3 className="text-xl font-bold text-slate-800 mb-2">Pengesahan Padam</h3>
                            <p className="text-slate-600 mb-6">Adakah anda pasti mahu memadam <strong>"{itemName}"</strong>?<br/><span className="text-xs text-red-500 font-semibold">Tindakan ini tidak boleh dikembalikan.</span></p>
                            <div className="flex space-x-3">
                                <button type="button" onClick={onClose} className="flex-1 bg-slate-100 text-slate-700 py-2.5 rounded-lg font-semibold hover:bg-slate-200 transition-colors">Batal</button>
                                <button type="button" onClick={onConfirm} className="flex-1 bg-red-600 text-white py-2.5 rounded-lg font-semibold hover:bg-red-700 transition-colors shadow-lg">Ya, Padam</button>
                            </div>
                        </div>
                </div>
                </div>
            );
        };
        const BulkDeleteModal = ({ isOpen, onClose, onConfirm, count }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[150] p-4 fade-in">
                    <div className="bg-white rounded-xl max-w-sm w-full p-6 shadow-2xl border-2 border-red-100 transform scale-100 transition-all">
                        <div className="text-center">
                            <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <Icons.Trash2 className="w-8 h-8 text-red-600" />
                            </div>
                            <h3 className="text-xl font-bold text-slate-800 mb-2">Kosongkan Rekod</h3>
                            <p className="text-slate-600 mb-6">Anda akan memadam <strong>{count} rekod</strong> yang terpapar.<br/><span className="text-xs text-red-500 font-semibold">Tindakan ini tidak boleh dikembalikan.</span></p>
                            <div className="flex space-x-3">
                                <button type="button" onClick={onClose} className="flex-1 bg-slate-100 text-slate-700 py-2.5 rounded-lg font-semibold hover:bg-slate-200 transition-colors">Batal</button>
                                <button type="button" onClick={onConfirm} className="flex-1 bg-red-600 text-white py-2.5 rounded-lg font-semibold hover:bg-red-700 transition-colors shadow-lg">Ya, Kosongkan</button>
                            </div>
                        </div>
                </div>
                </div>
            );
        };
        const ResetPasswordModal = ({ isOpen, onClose, onConfirm, userName }) => {
            const [newPassword, setNewPassword] = useState('');
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[150] p-4 fade-in">
                    <div className="bg-white rounded-xl max-w-sm w-full p-6 shadow-2xl border border-blue-100">
                        <h3 className="text-lg font-bold text-slate-800 mb-1">Reset Kata Laluan</h3>
                        <p className="text-sm text-slate-500 mb-4">Tetapkan kata laluan baharu untuk <strong>{userName}</strong>.</p>
                        <input type="text" value={newPassword} onChange={(e) => setNewPassword(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm mb-4" placeholder="Kata Laluan Baru" />
                        <div className="flex space-x-3">
                            <button onClick={onClose} className="flex-1 bg-slate-100 text-slate-700 py-2 rounded-lg font-semibold hover:bg-slate-200 transition-colors">Batal</button>
                            <button onClick={() => { if(newPassword) { onConfirm(newPassword); setNewPassword(''); } }} className="flex-1 bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors shadow-md" disabled={!newPassword}>Simpan</button>
                        </div>
                    </div>
                </div>
            );
        };
        const ConicPieChart = ({ data, totalLabel = "Rekod" }) => {
            const total = data.reduce((acc, curr) => acc + curr.value, 0);
            if (total === 0) return <div className="flex items-center justify-center h-48 text-slate-400 bg-slate-50 rounded-full w-48 mx-auto text-sm bg-slate-50">Tiada Data</div>;
            let currentAngle = 0;
            const gradientString = data.map(item => {
                const start = currentAngle;
                const percentage = (item.value / total) * 100;
                currentAngle += percentage;
                return `${item.color} ${start}% ${currentAngle}%`;
            }).join(', ');
            return (
                <div className="flex flex-col items-center">
                    <div className="w-48 h-48 rounded-full shadow-lg mb-6 relative" style={{ background: `conic-gradient(${gradientString})` }}>
                        <div className="absolute inset-0 m-auto w-32 h-32 bg-white rounded-full flex items-center justify-center shadow-inner">
                            <div className="text-center"><span className="text-2xl font-bold text-slate-800 block">{total}</span><span className="text-xs text-slate-500 uppercase tracking-wide">{totalLabel}</span></div>
                        </div>
                    </div>
                    <div className="w-full space-y-2 px-4">
                        {data.map((item, idx) => (
                            <div key={idx} className="flex justify-between items-center text-sm border-b border-slate-50 pb-1 last:border-0">
                                <div className="flex items-center"><span className="w-3 h-3 rounded-full mr-2 shadow-sm" style={{ backgroundColor: item.color }}></span><span className="text-slate-600 truncate max-w-[120px]" title={item.label}>{item.label}</span></div>
                                <span className="font-semibold text-slate-800">{Math.round((item.value/total)*100)}% <span className="text-slate-400 text-xs font-normal">({item.value})</span></span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        
        // (B) Searchable Location Select
        const SearchableLocationSelect = ({ options, value, onChange, placeholder }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const wrapperRef = useRef(null);

            useEffect(() => {
                function handleClickOutside(event) {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                }
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [wrapperRef]);

            useEffect(() => {
                // If the value changes externally (e.g., category change), update internal state
                setSearchTerm(value || '');
            }, [value]);

            const groupedOptions = useMemo(() => {
                const groups = {
                    'Sekolah Rendah': [],
                    'Sekolah Menengah': [],
                    'Lain-Lain Tempat': []
                };

                options.forEach(opt => {
                    const name = opt.name || opt;
                    const category = opt.category || 'Lain-Lain Tempat';
                    
                    if (name.toLowerCase().includes(searchTerm.toLowerCase())) {
                         if (groups[category]) {
                             groups[category].push(name);
                         } else {
                             groups['Lain-Lain Tempat'].push(name);
                         }
                    }
                });
                return groups;
            }, [options, searchTerm]);

            const handleSelect = (name) => {
                setSearchTerm(name);
                onChange(name);
                setIsOpen(false);
            };

            return (
                <div className="relative" ref={wrapperRef}>
                    <div className="relative">
                         <input 
                            type="text"
                            className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            placeholder={placeholder}
                            value={searchTerm}
                            onChange={(e) => { setSearchTerm(e.target.value); setIsOpen(true); onChange(e.target.value); }}
                            onFocus={() => setIsOpen(true)}
                        />
                        <div className="absolute right-3 top-3 text-slate-400 pointer-events-none">
                            {isOpen ? <Icons.X className="w-4 h-4"/> : <Icons.ChevronDown className="w-4 h-4"/>}
                        </div>
                    </div>

                    {isOpen && searchTerm && (
                        <div className="absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar">
                            {Object.entries(groupedOptions).map(([category, items]) => (
                                items.length > 0 && (
                                    <div key={category}>
                                        <div className="px-3 py-1.5 bg-slate-100 text-xs font-bold text-slate-500 uppercase sticky top-0">
                                            {category}
                                        </div>
                                        {items.map(item => (
                                            <div 
                                                key={item} 
                                                className="px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-700 cursor-pointer transition-colors"
                                                onClick={() => handleSelect(item)}
                                            >
                                                {item}
                                            </div>
                                        ))}
                                    </div>
                                )
                            ))}
                            {Object.values(groupedOptions).every(arr => arr.length === 0) && (
                                <div className="px-4 py-3 text-sm text-slate-400 italic text-center">
                                    Tiada padanan. Tekan hantar untuk simpan "{searchTerm}".
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };
        
        // (C) Login Page
        const LoginPage = ({ onLogin, onRegister, error, usersLoading }) => {
            const [isRegistering, setIsRegistering] = useState(false);
            const [roleTab, setRoleTab] = useState('staff');
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [fullName, setFullName] = useState('');
            const [department, setDepartment] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (usersLoading) return;
                // Since this environment doesn't allow Firestore write/auth fully, we alert on register for demo
                if (isRegistering) { 
                    onRegister({ username, password, name: fullName, department, role: 'staff' }); 
                    setIsRegistering(false); 
                    setUsername(''); 
                    setPassword(''); 
                } 
                else { onLogin(username, password, roleTab); }
            };

            return (
                <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4 font-sans">
                    <div className="max-w-md w-full bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100 fade-in">
                        <div className="bg-blue-900 p-8 text-center relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-full bg-blue-800 opacity-20 transform -skew-y-6 origin-top-left"></div>
                            <div className="relative z-10">
                                <div className="w-16 h-16 bg-white rounded-full mx-auto mb-4 flex items-center justify-center shadow-lg"><Icons.MapPin className="text-blue-900 w-8 h-8" /></div>
                                <h1 className="text-2xl font-bold text-white tracking-wide">E-Gerak</h1>
                                <p className="text-blue-200 text-sm mt-1">Pejabat Pendidikan Daerah Ranau</p>
                            </div>
                        </div>
                        <div className="p-8">
                            {usersLoading ? (
                                <div className="text-center py-8 text-slate-500"><Icons.RefreshCw className="w-8 h-8 animate-spin mx-auto mb-2 text-blue-600"/>Sedang menghubungkan...</div>
                            ) : (
                                <>
                                    {!isRegistering && (
                                        <div className="flex bg-slate-100 rounded-lg p-1 mb-6">
                                            <button onClick={() => setRoleTab('staff')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${roleTab === 'staff' ? 'bg-white text-blue-900 shadow-sm' : 'text-slate-500'}`}>Staf / Pegawai</button>
                                            <button onClick={() => setRoleTab('admin')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${roleTab === 'admin' ? 'bg-white text-blue-900 shadow-sm' : 'text-slate-500'}`}>Admin / Pentadbir</button>
                                        </div>
                                    )}
                                    {isRegistering && (<div className="mb-6 text-center"><h2 className="text-lg font-bold text-slate-800">Pendaftaran Pengguna Baru</h2><p className="text-xs text-slate-500">Sila isi maklumat untuk akaun kali pertama.</p></div>)}
                                    <form onSubmit={handleSubmit} className="space-y-4">
                                        {isRegistering && (
                                            <>
                                                <div><label className="block text-sm font-medium text-slate-700 mb-1">Nama Penuh</label><input type="text" required value={fullName} onChange={(e) => setFullName(e.target.value.toUpperCase())} className="block w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" /></div>
                                                <div><label className="block text-sm font-medium text-slate-700 mb-1">Unit / Sekolah</label><input type="text" required value={department} onChange={(e) => setDepartment(e.target.value)} className="block w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" /></div>
                                            </>
                                        )}
                                        <div><label className="block text-sm font-medium text-slate-700 mb-1">ID Pengguna</label><input type="text" required value={username} onChange={(e) => setUsername(e.target.value)} className="block w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder={roleTab === 'admin' ? "admin" : "staff"} /></div>
                                        <div><label className="block text-sm font-medium text-slate-700 mb-1">Kata Laluan</label><input type="password" required value={password} onChange={(e) => setPassword(e.target.value)} className="block w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="•••••••" /></div>
                                        {error && <div className="bg-red-50 text-red-600 text-sm p-3 rounded-lg flex items-center animate-pulse"><span className="mr-2">⚠️</span> {error}</div>}
                                        <button type="submit" className="w-full bg-blue-900 text-white py-3 rounded-lg font-semibold shadow-md hover:bg-blue-800 transition-all">{isRegistering ? 'Daftar Akaun' : 'Log Masuk'}</button>
                                    </form>
                                    <div className="mt-6 text-center pt-4 border-t border-slate-100">{!isRegistering ? (<p className="text-sm text-slate-600">Pengguna kali pertama?{' '}<button onClick={() => { setIsRegistering(true); setRoleTab('staff'); }} className="text-blue-600 font-bold hover:underline">Daftar di sini</button></p>) : (<button onClick={() => setIsRegistering(false)} className="text-sm text-blue-600 hover:text-blue-800 font-medium">← Kembali ke Log Masuk</button>)}</div>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };
        
        // (D) Staff Dashboard Tabs
        const StaffEntryTab = ({ onSubmit, availableLocations, availableTypes }) => {
            const [formData, setFormData] = useState({ date: new Date().toISOString().split('T')[0], location: '', type: '', catatan: '', category: 'Sekolah Rendah' });
            const [useCustomType, setUseCustomType] = useState(false);
            const [isManualLocation, setIsManualLocation] = useState(false);
            const handleChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });

            const filteredLocations = useMemo(() => {
                return availableLocations.filter(loc => {
                    const cat = loc.category || 'Lain-Lain Tempat';
                    return cat === formData.category;
                });
            }, [availableLocations, formData.category]);

            return (
                <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-sm border border-slate-100 p-6 md:p-8 fade-in">
                    <div className="flex items-center space-x-3 mb-6"><div className="bg-blue-100 p-2 rounded-lg"><Icons.Plus className="w-6 h-6 text-blue-700" /></div><div><h2 className="text-xl font-bold text-slate-800">Daftar Pergerakan Harian</h2><p className="text-slate-500 text-sm">Sila isi maklumat pergerakan anda.</p></div></div>
                    <form onSubmit={(e) => { e.preventDefault(); onSubmit(formData); setFormData({...formData, catatan: '', location: '', type: '', category: 'Sekolah Rendah'}); setIsManualLocation(false); }} className="space-y-6">
                        
                        <div><label className="block text-sm font-medium text-slate-700 mb-2">Tarikh Pergerakan</label><input type="date" name="date" required value={formData.date} onChange={handleChange} className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" /></div>
                        
                        {/* CATEGORY SELECTOR (BUTTONS) */}
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-2">Kategori Tempat</label>
                            <div className="flex flex-wrap gap-2">
                                {LOCATION_CATEGORIES.map(cat => (
                                    <button 
                                        key={cat}
                                        type="button"
                                        onClick={() => { setFormData({...formData, category: cat, location: ''}); setIsManualLocation(false); }}
                                        className={`px-3 py-1.5 text-xs font-bold rounded-full transition-colors ${formData.category === cat ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}
                                    >
                                        {cat}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* SMART SEARCH LOCATION */}
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-2">Lokasi / Tempat</label>
                            {isManualLocation ? (
                                <div className="flex gap-2">
                                    <input 
                                        type="text" 
                                        name="location" 
                                        required 
                                        value={formData.location} 
                                        onChange={handleChange} 
                                        placeholder="Taip nama tempat..." 
                                        className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-blue-50" 
                                    />
                                    <button 
                                        type="button" 
                                        onClick={() => setIsManualLocation(false)}
                                        className="px-3 bg-slate-100 hover:bg-slate-200 rounded-lg border"
                                        title="Kembali ke Carian"
                                    >
                                        <Icons.ListIcon className="w-5 h-5"/>
                                    </button>
                                </div>
                            ) : (
                                <div className="flex gap-2">
                                    <div className="flex-1">
                                         <SearchableLocationSelect 
                                            options={filteredLocations} 
                                            value={formData.location}
                                            onChange={(val) => setFormData({...formData, location: val})}
                                            placeholder={`Cari dalam ${formData.category}...`}
                                        />
                                    </div>
                                    {formData.category === 'Lain-Lain Tempat' && (
                                        <button 
                                            type="button"
                                            onClick={() => { setIsManualLocation(true); setFormData({...formData, location: ''}); }}
                                            className="px-3 bg-blue-50 text-blue-600 hover:bg-blue-100 rounded-lg border border-blue-200 font-bold text-xs whitespace-nowrap"
                                        >
                                            + Tambah
                                        </button>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* ACTIVITY */}
                        <div><label className="block text-sm font-medium text-slate-700 mb-2">Perkara / Tujuan</label><div className="flex gap-2"><div className="relative w-full">{useCustomType ? (<input type="text" name="type" required value={formData.type} onChange={handleChange} placeholder="Sila taip tujuan baru..." className="w-full px-4 py-2.5 border border-slate-300 rounded-lg" />) : (<select name="type" required value={formData.type} onChange={handleChange} className="w-full px-4 py-2.5 border border-slate-300 rounded-lg appearance-none bg-white" ><option value="">Pilih Tujuan...</option>{availableTypes.map((type, idx) => (<option key={idx} value={type.name || type}>{type.name || type}</option>))}</select>)}</div><button type="button" onClick={() => { setUseCustomType(!useCustomType); setFormData({...formData, type: ''}); }} className="px-3 bg-slate-100 rounded-lg border">{useCustomType ? <Icons.ListIcon className="w-5 h-5"/> : <Icons.Plus className="w-5 h-5"/>}</button></div></div>
                        
                        <div><label className="block text-sm font-medium text-slate-700 mb-2">Catatan</label><textarea name="catatan" rows="3" value={formData.catatan} onChange={handleChange} placeholder="Catatan tambahan..." className="w-full px-4 py-2.5 border border-slate-300 rounded-lg" ></textarea></div>
                        <div className="pt-4 border-t border-slate-100"><button type="submit" className="w-full bg-blue-900 text-white py-3 rounded-lg font-bold shadow-md hover:bg-blue-800 flex justify-center items-center space-x-2"><Icons.CheckCircle className="w-5 h-5" /><span>Hantar Rekod</span></button></div>
                    </form>
                </div>
            );
        };

        const StaffFilterTab = ({ logs, combinedLocations, combinedActivityTypes }) => {
            const [filterDate, setFilterDate] = useState('');
            const [filterPlace, setFilterPlace] = useState('');
            const [filterType, setFilterType] = useState('');
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const isFilterActive = filterDate || filterPlace || filterType;
            const filteredLogs = logs.filter(log => {
                if (!isFilterActive) return log.date.startsWith(currentMonth);
                return (filterDate ? log.date === filterDate : true) && (filterPlace ? log.location === filterPlace : true) && (filterType ? log.type === filterType : true);
            });

            return (
                <div className="space-y-6">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100"><h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center"><Icons.Filter className="w-5 h-5 mr-2 text-blue-600" /> Saring & Cari Rekod</h3><div className="grid grid-cols-1 md:grid-cols-3 gap-4"><input type="date" value={filterDate} onChange={(e) => setFilterDate(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm" /><select value={filterPlace} onChange={(e) => setFilterPlace(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm"><option value="">Semua Lokasi</option>{combinedLocations.map((l,i) => <option key={i} value={l.name || l}>{l.name || l}</option>)}</select><select value={filterType} onChange={(e) => setFilterType(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm"><option value="">Semua Perkara</option>{combinedActivityTypes.map(t => <option key={t} value={t}>{t}</option>)}</select></div><div className="mt-4 flex justify-end"><button onClick={() => { setFilterDate(''); setFilterPlace(''); setFilterType(''); }} className="text-sm text-red-500 hover:text-red-700 underline">Kosongkan Saringan</button></div></div>
                    <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">{!isFilterActive && (<div className="bg-blue-50 px-6 py-2 text-xs text-blue-700 border-b border-blue-100 flex items-center"><Icons.Info className="w-4 h-4 mr-2"/><span>Memaparkan rekod bulan semasa ({currentMonth}).</span></div>)}<div className="overflow-x-auto"><table className="w-full text-sm text-left text-slate-600"><thead className="text-xs text-slate-500 uppercase bg-slate-50"><tr><th className="px-6 py-3">Tarikh</th><th className="px-6 py-3">Lokasi</th><th className="px-6 py-3">Tujuan</th><th className="px-6 py-3">Catatan</th></tr></thead><tbody>{filteredLogs.length > 0 ? filteredLogs.map((log) => (<tr key={log.id} className="border-b hover:bg-slate-50"><td className="px-6 py-4 font-medium">{formatDate(log.date)}</td><td className="px-6 py-4">{log.location}</td><td className="px-6 py-4">{log.type}</td><td className="px-6 py-4 italic text-slate-500">{log.catatan || '-'}</td></tr>)) : (<tr><td colSpan="4" className="px-6 py-8 text-center text-slate-400">Tiada rekod ditemui.</td></tr>)}</tbody></table></div></div>
                </div>
            );
        };

        const StaffReportTab = ({ logs }) => {
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const monthlyLogs = logs.filter(log => log.date.startsWith(selectedMonth));
            return (
                <div className="space-y-6"><div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4"><div><h3 className="text-lg font-bold text-slate-800">Laporan Bulanan</h3><p className="text-slate-500 text-sm">Pilih bulan untuk melihat dan memuat turun rekod.</p></div><div className="flex items-center space-x-2"><Icons.CalendarIcon className="w-5 h-5 text-slate-400" /><input type="month" value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)} className="border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500" /></div></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><button onClick={() => downloadCSV(monthlyLogs, `Log_Pergerakan_${selectedMonth}.csv`)} className="flex items-center justify-center space-x-2 bg-green-600 text-white p-4 rounded-xl shadow-sm hover:bg-green-700 transition-colors"><Icons.FileSpreadsheet className="w-6 h-6" /><div className="text-left"><div className="font-bold">Muat Turun Excel (CSV)</div><div className="text-xs text-green-100">Format hamparan standard</div></div></button><button onClick={() => window.print()} className="flex items-center justify-center space-x-2 bg-slate-700 text-white p-4 rounded-xl shadow-sm hover:bg-slate-800 transition-colors"><Icons.Printer className="w-6 h-6" /><div className="text-left"><div className="font-bold">Cetak / Simpan PDF</div><div className="text-xs text-slate-300">Menggunakan pencetak sistem</div></div></button></div><div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden print:shadow-none print:border-none"><div className="p-4 bg-slate-50 border-b border-slate-100 font-semibold text-slate-700 flex justify-between"><span>Pratonton Laporan: {selectedMonth}</span><span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">{monthlyLogs.length} Rekod</span></div><table className="w-full text-sm text-left text-slate-600"><thead className="text-xs text-slate-500 uppercase bg-slate-50"><tr><th className="px-4 py-3">Tarikh</th><th className="px-4 py-3">Tempat</th><th className="px-4 py-3">Perkara</th><th className="px-4 py-3">Catatan</th></tr></thead><tbody>{monthlyLogs.map((log) => (<tr key={log.id} className="border-b"><td className="px-4 py-3">{formatDate(log.date)}</td><td className="px-4 py-3">{log.location}</td><td className="px-4 py-3">{log.type}</td><td className="px-4 py-3 italic">{log.catatan || '-'}</td></tr>))}{monthlyLogs.length === 0 && (<tr><td colSpan="4" className="px-4 py-8 text-center text-slate-400">Tiada rekod untuk bulan ini.</td></tr>)}</tbody></table></div></div>
            );
        };

        const StaffDashboard = ({ user, logs, onAddLog, combinedLocations, combinedActivityTypes }) => {
            const [activeTab, setActiveTab] = useState('daftar'); 
            return (
                <div className="p-6 lg:p-10 flex-1 max-w-7xl mx-auto">
                    <div className="mb-8"><h1 className="text-2xl font-bold text-slate-800">Selamat Datang, {user.name}</h1><p className="text-slate-500">{user.department}</p></div>
                    <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 border-b border-slate-200 mb-6">
                        <button onClick={() => setActiveTab('daftar')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 ${activeTab === 'daftar' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500'}`}><span className="flex items-center space-x-2"><Icons.Plus className="w-4 h-4"/> <span>Daftar Pergerakan</span></span></button>
                        <button onClick={() => setActiveTab('saring')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 ${activeTab === 'saring' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500'}`}><span className="flex items-center space-x-2"><Icons.Filter className="w-4 h-4"/> <span>Saring Rekod</span></span></button>
                        <button onClick={() => setActiveTab('laporan')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 ${activeTab === 'laporan' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500'}`}><span className="flex items-center space-x-2"><Icons.FileText className="w-4 h-4"/> <span>Laporan Bulanan</span></span></button>
                    </div>
                    <div className="min-h-[400px]">
                        {activeTab === 'daftar' && (<StaffEntryTab onSubmit={onAddLog} availableLocations={combinedLocations} availableTypes={combinedActivityTypes} />)}
                        {activeTab === 'saring' && <StaffFilterTab logs={logs} combinedLocations={combinedLocations} combinedActivityTypes={combinedActivityTypes} />}
                        {activeTab === 'laporan' && <StaffReportTab logs={logs} />}
                    </div>
                </div>
            );
        };

        // (E) Admin Dashboard Tabs
        const AdminDataManagementTab = ({ 
            locations, activityTypes, users, logs,
            onAddLocation, onDeleteLocation, 
            onAddActivity, onDeleteActivity,
            onDeleteUser, onResetUserPassword 
        }) => {
            const [newLocation, setNewLocation] = useState('');
            const [newLocationCategory, setNewLocationCategory] = useState('Sekolah Rendah');
            const [newActivity, setNewActivity] = useState('');
            const [itemToDelete, setItemToDelete] = useState(null); 
            const [userToReset, setUserToReset] = useState(null);

            // SIMULATED DELETE LOGIC
            const triggerDelete = (type, id, name) => setItemToDelete({ type, id, name });
            const confirmDelete = () => { 
                if (!itemToDelete) return; 
                const { type, id } = itemToDelete; 
                
                // Placeholder for actual Firebase interaction
                if (type === 'location') onDeleteLocation(id); 
                if (type === 'activity') onDeleteActivity(id); 
                if (type === 'user') onDeleteUser(id); 
                
                setItemToDelete(null); 
            }; 

            const sortedUsers = [...users].sort((a, b) => a.name.localeCompare(b.name));
            const nameCounts = sortedUsers.reduce((acc, user) => { acc[user.name] = (acc[user.name] || 0) + 1; return acc; }, {});
            const onlineUsers = sortedUsers.filter(u => isUserOnline(u.lastSeen));

            return (
                <div className="space-y-10 fade-in">
                    {/* SECTION 1: MASTER DATA */}
                    <div>
                         <h2 className="text-xl font-bold text-slate-800 mb-4 border-b pb-2">Seksyen 1: Data Master (Lokasi & Perkara)</h2>
                         <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {/* Locations with Category */}
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center"><Icons.MapPin className="w-5 h-5 mr-2 text-blue-600" /> Senarai Lokasi ({locations.length})</h3>
                                <div className="flex gap-2 mb-2">
                                    <input type="text" value={newLocation} onChange={(e) => setNewLocation(e.target.value)} placeholder="Nama Lokasi..." className="flex-1 border border-slate-300 rounded-lg p-2 text-sm" />
                                    <button type="button" onClick={() => { if(newLocation) { onAddLocation(newLocation, newLocationCategory); setNewLocation(''); }}} className="bg-blue-600 text-white px-3 rounded-lg hover:bg-blue-700"><Icons.Plus className="w-5 h-5" /></button>
                                </div>
                                <div className="mb-4">
                                    <select value={newLocationCategory} onChange={(e) => setNewLocationCategory(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-xs text-slate-600">
                                        {LOCATION_CATEGORIES.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                    </select>
                                </div>
                                <div className="max-h-60 overflow-y-auto space-y-2">
                                    {locations.map((loc) => (
                                        <div key={loc.id} className="flex justify-between items-center bg-slate-50 p-2 rounded text-sm">
                                            <div>
                                                <span className="block font-medium">{loc.name}</span>
                                                <span className="text-xs text-slate-400">{loc.category || 'Lain-Lain Tempat'}</span>
                                            </div>
                                            <button type="button" onClick={() => triggerDelete('location', loc.id, loc.name)} className="text-slate-400 hover:text-red-500 p-2"><Icons.Trash2 className="w-5 h-5" /></button>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Activities */}
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center"><Icons.FileText className="w-5 h-5 mr-2 text-blue-600" /> Senarai Perkara ({activityTypes.length})</h3>
                                <div className="flex gap-2 mb-4">
                                    <input type="text" value={newActivity} onChange={(e) => setNewActivity(e.target.value)} placeholder="Tambah perkara..." className="flex-1 border border-slate-300 rounded-lg p-2 text-sm" />
                                    <button type="button" onClick={() => { if(newActivity) { onAddActivity(newActivity); setNewActivity(''); }}} className="bg-blue-600 text-white px-3 rounded-lg hover:bg-blue-700"><Icons.Plus className="w-5 h-5" /></button>
                                </div>
                                <div className="max-h-60 overflow-y-auto space-y-2">{activityTypes.map((type) => (<div key={type.id} className="flex justify-between items-center bg-slate-50 p-2 rounded text-sm"><span>{type.name}</span><button type="button" onClick={() => triggerDelete('activity', type.id, type.name)} className="text-slate-400 hover:text-red-500 p-2"><Icons.Trash2 className="w-5 h-5" /></button></div>))}</div>
                            </div>
                            
                        </div>
                    </div>
                    {/* SECTION 2: ONLINE USERS */}
                    <div>
                        <h2 className="text-xl font-bold text-slate-800 mb-4 border-b pb-2">Seksyen 2: Pengguna Sedang Online ({onlineUsers.length})</h2>
                        <div className="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
                             {onlineUsers.length === 0 ? (
                                 <p className="text-slate-400 italic">Tiada pengguna sedang online.</p>
                             ) : (
                                 <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {onlineUsers.map(u => (
                                        <div key={u.id} className="flex items-center p-3 bg-white rounded-lg border border-slate-200 shadow-sm">
                                            <div className="relative mr-3">
                                                <div className="w-10 h-10 bg-slate-200 rounded-full flex items-center justify-center text-slate-600 font-bold">{u.name.charAt(0)}</div>
                                                <div className="absolute bottom-0 right-0 online-dot border-2 border-white"></div>
                                            </div>
                                            <div><p className="font-semibold text-sm text-slate-800">{u.name}</p><p className="text-xs text-slate-500">{u.department}</p></div>
                                        </div>
                                    ))}
                                 </div>
                             )}
                        </div>
                    </div>
                    {/* SECTION 3: REGISTERED USERS */}
                    <div>
                        <h2 className="text-xl font-bold text-slate-800 mb-4 border-b pb-2">Seksyen 3: Pengurusan Pengguna Berdaftar ({sortedUsers.length})</h2>
                        <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-slate-600">
                                    <thead className="bg-slate-50 text-xs uppercase text-slate-500"><tr><th className="px-6 py-3">Nama Penuh</th><th className="px-6 py-3">ID Pengguna</th><th className="px-6 py-3">Jabatan</th><th className="px-6 py-3 text-right">Tindakan</th></tr></thead>
                                    <tbody>
                                         {/* Start of fixed mapping for table rows */}
                                        {sortedUsers.map(user => { 
                                            const isDuplicate = nameCounts[user.name] > 1; 
                                            return (
                                                <tr key={user.id} className={`border-b ${isDuplicate ? 'bg-pink-50' : 'hover:bg-slate-50'}`}>
                                                    <td className="px-6 py-4 font-medium text-slate-900 flex items-center">{user.name}{isDuplicate && <span className="ml-2 text-pink-600" title="Nama Pendua"><Icons.AlertTriangle className="w-4 h-4"/></span>}</td>
                                                    <td className="px-6 py-4">{user.username}</td><td className="px-6 py-4">{user.department}</td>
                                                    <td className="px-6 py-4 text-right">
                                                        {user.role !== 'admin' && (
                                                            <div className="flex justify-end gap-2">
                                                                <button type="button" onClick={() => setUserToReset(user)} className="text-blue-500 hover:text-blue-700 bg-blue-50 p-2 rounded-lg" title="Reset Kata Laluan"><Icons.Key className="w-5 h-5" /></button>
                                                                <button type="button" onClick={() => triggerDelete('user', user.id, user.name)} className="text-red-500 hover:text-red-700 bg-red-50 p-2 rounded-lg" title="Padam Pengguna"><Icons.Trash2 className="w-5 h-5" /></button>
                                                            </div>
                                                        )}
                                                    </td>
                                                </tr>
                                            ); 
                                        })}
                                         {/* End of fixed mapping for table rows */}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <DeleteConfirmationModal isOpen={!!itemToDelete} onClose={() => setItemToDelete(null)} onConfirm={confirmDelete} itemName={itemToDelete?.name} />
                    <ResetPasswordModal isOpen={!!userToReset} onClose={() => setUserToReset(null)} onConfirm={(newPw) => { onResetUserPassword(userToReset.id, newPw); setUserToReset(null); }} userName={userToReset?.name} />
                </div>
            );
        };
        const AdminAnalysisTab = ({ logs, allUsers, combinedLocations, combinedActivityTypes, onDeleteLog }) => {
            const [filterMonth, setFilterMonth] = useState('');
            const [filterStaff, setFilterStaff] = useState('');
            const [filterPlace, setFilterPlace] = useState('');
            const [filterType, setFilterType] = useState('');
            const [showBulkDeleteConfirm, setShowBulkDeleteConfirm] = useState(false);
            const [recordToDelete, setRecordToDelete] = useState(null);

            const filteredLogs = logs.filter(log => {
                if (!log.date) return false;
                const matchMonth = filterMonth ? log.date.startsWith(filterMonth) : true;
                const matchStaff = filterStaff ? log.userName === filterStaff : true;
                const matchPlace = filterPlace ? log.location === filterPlace : true;
                const matchType = filterType ? log.type === filterType : true;
                return matchMonth && matchStaff && matchPlace && matchType;
            });

            const handleBulkDelete = () => {
                onDeleteLog(filteredLogs.map(l => l.id)); // Send array of IDs for simulated bulk delete
                setShowBulkDeleteConfirm(false);
            };

            const confirmSingleDelete = () => {
                if (recordToDelete) { onDeleteLog(recordToDelete); setRecordToDelete(null); }
            };

            return (
                <div className="space-y-6 fade-in">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-slate-800 flex items-center"><Icons.Filter className="w-5 h-5 mr-2 text-blue-600" /> Analisis Rekod</h3>
                            {filteredLogs.length > 0 && (
                                <button onClick={() => setShowBulkDeleteConfirm(true)} className="flex items-center space-x-1 text-xs font-bold text-white bg-red-600 hover:bg-red-700 px-3 py-2 rounded-lg shadow-sm transition-colors"><Icons.Trash2 className="w-4 h-4"/> <span>Kosongkan Rekod ({filteredLogs.length})</span></button>
                            )}
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div><label className="block text-xs font-semibold text-slate-500 mb-1">Bulan</label><input type="month" value={filterMonth} onChange={(e) => setFilterMonth(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500" /></div>
                            <div><label className="block text-xs font-semibold text-slate-500 mb-1">Staf</label><select value={filterStaff} onChange={(e) => setFilterStaff(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500"><option value="">Semua Staf</option>{allUsers.map((u, idx) => <option key={idx} value={u}>{u}</option>)}</select></div>
                            <div><label className="block text-xs font-semibold text-slate-500 mb-1">Lokasi</label><select value={filterPlace} onChange={(e) => setFilterPlace(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500"><option value="">Semua Lokasi</option>{combinedLocations.map((loc, idx) => <option key={idx} value={loc.name || loc}>{loc.name || loc}</option>)}</select></div>
                            <div><label className="block text-xs font-semibold text-slate-500 mb-1">Perkara</label><select value={filterType} onChange={(e) => setFilterType(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500"><option value="">Semua Perkara</option>{combinedActivityTypes.map((type, idx) => <option key={idx} value={type.name || type}>{type.name || type}</option>)}</select></div>
                        </div>
                        <div className="mt-4 pt-2 border-t border-slate-50 flex justify-between items-center">
                            <span className="text-sm text-slate-500">Jumlah: <strong>{filteredLogs.length}</strong> rekod dijumpai.</span>
                            <button type="button" onClick={() => { setFilterMonth(''); setFilterStaff(''); setFilterPlace(''); setFilterType(''); }} className="text-sm text-blue-600 hover:text-blue-800 font-medium">Reset Saringan (Filter)</button>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left text-slate-600">
                                <thead className="bg-slate-50 text-xs uppercase text-slate-500"><tr><th className="px-6 py-3">Tarikh</th><th className="px-6 py-3">Nama</th><th className="px-6 py-3">Lokasi</th><th className="px-6 py-3">Perkara</th><th className="px-6 py-3 text-right">Tindakan</th></tr></thead>
                                <tbody>
                                    {filteredLogs.length > 0 ? filteredLogs.map(log => (
                                        <tr key={log.id} className="border-b hover:bg-slate-50">
                                            <td className="px-6 py-4">{formatDate(log.date)}</td>
                                            <td className="px-6 py-4 font-bold text-slate-800">{log.userName}</td>
                                            <td className="px-6 py-4">{log.location}</td>
                                            <td className="px-6 py-4">{log.type}</td>
                                            <td className="px-6 py-4 text-right"><button type="button" onClick={() => setRecordToDelete(log.id)} className="text-red-500 hover:text-red-700 p-1 bg-red-50 rounded" title="Padam Rekod Ini"><Icons.Trash2 className="w-4 h-4"/></button></td>
                                        </tr>
                                    )) : (<tr><td colSpan="5" className="px-6 py-12 text-center text-slate-400">Tiada rekod ditemui.</td></tr>)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <BulkDeleteModal isOpen={showBulkDeleteConfirm} onClose={() => setShowBulkDeleteConfirm(false)} onConfirm={handleBulkDelete} count={filteredLogs.length} />
                    <DeleteConfirmationModal isOpen={!!recordToDelete} onClose={() => setRecordToDelete(null)} onConfirm={confirmSingleDelete} itemName="Rekod Log Ini" />
                </div>
            );
        };
        const AdminStatsTab = ({ logs, allUsers, combinedLocations, combinedActivityTypes }) => {
            const [filterMonth, setFilterMonth] = useState(''); const [filterStaff, setFilterStaff] = useState(''); const [filterPlace, setFilterPlace] = useState(''); const [filterType, setFilterType] = useState('');
            const filteredLogs = logs.filter(log => { if (!log.date) return false; const matchMonth = filterMonth ? log.date.startsWith(filterMonth) : true; const matchStaff = filterStaff ? log.userName === filterStaff : true; const matchPlace = filterPlace ? log.location === filterPlace : true; const matchType = filterType ? log.type === filterType : true; return matchMonth && matchStaff && matchPlace && matchType; });
            const getChartData = (key) => { const counts = filteredLogs.reduce((acc, log) => { const val = log[key] || 'Lain-lain'; acc[val] = (acc[val] || 0) + 1; return acc; }, {}); const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1']; return Object.keys(counts).map((label, i) => ({ label, value: counts[label], color: colors[i % colors.length] })).sort((a,b) => b.value - a.value); };

            return (
                <div className="space-y-8 fade-in">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100"><h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center"><Icons.Filter className="w-5 h-5 mr-2 text-blue-600" /> Saring Data Statistik</h3><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><div><label className="block text-xs font-semibold text-slate-500 mb-1">Bulan</label><input type="month" value={filterMonth} onChange={(e) => setFilterMonth(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500" /></div><div><label className="block text-xs font-semibold text-slate-500 mb-1">Staf</label><select value={filterStaff} onChange={(e) => setFilterStaff(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500"><option value="">Semua Staf</option>{allUsers.map((u, idx) => <option key={idx} value={u}>{u}</option>)}</select></div><div><label className="block text-xs font-semibold text-slate-500 mb-1">Lokasi</label><select value={filterPlace} onChange={(e) => setFilterPlace(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500"><option value="">Semua Lokasi</option>{combinedLocations.map((loc, idx) => <option key={idx} value={loc.name || loc}>{loc.name || loc}</option>)}</select></div><div><label className="block text-xs font-semibold text-slate-500 mb-1">Perkara</label><select value={filterType} onChange={(e) => setFilterType(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500"><option value="">Semua Perkara</option>{combinedActivityTypes.map((type, idx) => <option key={idx} value={type.name || type}>{type.name || type}</option>)}</select></div></div><div className="mt-4 flex justify-between items-center pt-2 border-t border-slate-50"><span className="text-sm text-blue-600 hover:text-blue-800 font-medium">Rekod diproses: {filteredLogs.length}</span><button type="button" onClick={() => { setFilterMonth(''); setFilterStaff(''); setFilterPlace(''); setFilterType(''); }} className="text-sm text-blue-600 hover:text-blue-800 font-medium">Kosongkan Semua</button></div></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col"><h4 className="font-bold text-slate-800 text-center mb-6 border-b pb-2">Peratus Mengikut Perkara</h4><div className="flex-1 flex items-center justify-center"><ConicPieChart data={getChartData('type')} /></div></div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col"><h4 className="font-bold text-slate-800 text-center mb-6 border-b pb-2">Peratus Mengikut Tempat</h4><div className="flex-1 flex items-center justify-center"><ConicPieChart data={getChartData('location')} /></div></div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col"><h4 className="font-bold text-slate-800 text-center mb-6 border-b pb-2">Peratus Mengikut Staf</h4><div className="flex-1 flex items-center justify-center"><ConicPieChart data={getChartData('userName')} totalLabel="Staf Aktif" /></div></div>
                    </div>
                </div>
            );
        };
        const AdminLeaderboardTab = ({ logs }) => {
            const [filterMonth, setFilterMonth] = useState('');
            const filteredLogs = logs.filter(log => { if (!log.date) return false; return filterMonth ? log.date.startsWith(filterMonth) : true; });
            const totalEntries = filteredLogs.reduce((acc, log) => { acc[log.userName] = (acc[log.userName] || 0) + 1; return acc; }, {});
            const sortedTotal = Object.entries(totalEntries).sort((a, b) => b[1] - a[1]).map(([name, count], i) => ({ rank: i + 1, name, count }));
            const coachingLogs = filteredLogs.filter(log => { const text = (log.type + ' ' + (log.catatan || '')).toLowerCase(); return text.includes('bimbingan') || text.includes('coaching') || text.includes('mentoring') || text.includes('lawatan'); });
            const coachingEntries = coachingLogs.reduce((acc, log) => { acc[log.userName] = (acc[log.userName] || 0) + 1; return acc; }, {});
            const sortedCoaching = Object.entries(coachingEntries).sort((a, b) => b[1] - a[1]).map(([name, count], i) => ({ rank: i + 1, name, count }));
            const RankTable = ({ title, data, icon: Icon, color }) => ( <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden h-full"><div className={`p-4 ${color} text-white font-bold flex items-center`}><Icon className="w-5 h-5 mr-2" /> {title}</div><table className="w-full text-sm text-left text-slate-600"><thead className="bg-slate-50 text-xs uppercase text-slate-500"><tr><th className="px-6 py-3 w-16">#</th><th className="px-6 py-3">Nama Pegawai</th><th className="px-6 py-3 text-right">Jumlah</th></tr></thead><tbody>{data.length > 0 ? data.map((item) => (<tr key={item.name} className="border-b hover:bg-slate-50 last:border-0"><td className="px-6 py-4 font-bold text-slate-400">{item.rank === 1 ? '🥇' : item.rank === 2 ? '🥈' : item.rank === 3 ? '🥉' : item.rank}</td><td className="px-6 py-4 font-medium text-slate-900">{item.name}</td><td className="px-6 py-4 text-right font-bold text-blue-900">{item.count}</td></tr>)) : (<tr><td colSpan="3" className="px-6 py-8 text-center text-slate-400">Tiada data direkodkan.</td></tr>)}</tbody></table></div>);
            return ( <div className="space-y-6 fade-in"><div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-center justify-between"><h3 className="text-lg font-bold text-slate-800 flex items-center"><Icons.Trophy className="w-5 h-5 mr-2 text-blue-600" /> Leaderboard Dinamik</h3><div className="flex items-center space-x-2"><label className="text-xs font-semibold text-slate-500">Saring Bulan:</label><input type="month" value={filterMonth} onChange={(e) => setFilterMonth(e.target.value)} className="border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500" /><button type="button" onClick={() => setFilterMonth('')} className="text-sm text-blue-600 hover:text-blue-800 ml-2">Reset</button></div></div><div className="grid grid-cols-1 md:grid-cols-2 gap-8"><RankTable title="Ranking Pengisian Terbanyak" data={sortedTotal} icon={Icons.Trophy} color="bg-blue-600" /><RankTable title="Ranking Lawatan & Bimbingan" data={sortedCoaching} icon={Icons.TrendingUp} color="bg-green-600" /></div></div> );
        };
        const AdminReportTab = ({ logs, allUsers, combinedLocations, combinedActivityTypes }) => {
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [filterStaff, setFilterStaff] = useState(''); 
            const [filterPlace, setFilterPlace] = useState(''); 
            const [filterType, setFilterType] = useState('');

            const filteredLogs = logs.filter(log => {
                if (!log.date) return false;
                const matchMonth = selectedMonth ? log.date.startsWith(selectedMonth) : true;
                const matchStaff = filterStaff ? log.userName === filterStaff : true;
                const matchPlace = filterPlace ? log.location === filterPlace : true;
                const matchType = filterType ? log.type === filterType : true;
                return matchMonth && matchStaff && matchPlace && matchType;
            });

            return (
                <div className="space-y-6 fade-in">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <h3 className="text-lg font-bold text-slate-800 flex items-center">
                            <Icons.Filter className="w-5 h-5 mr-2 text-blue-600" /> Saring & Muat Turun Laporan
                        </h3> {/* Corrected closing tag from </b></h3> to </h3> */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div><label className="block text-xs font-semibold text-slate-500 mb-1">Bulan</label><input type="month" value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500" /></div>
                            <div><label className="block text-xs font-semibold text-slate-500 mb-1">Staf</label><select value={filterStaff} onChange={(e) => setFilterStaff(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500"><option value="">Semua Staf</option>{allUsers.map((u, idx) => <option key={idx} value={u}>{u}</option>)}</select></div>
                            <div><label className="block text-xs font-semibold text-slate-500 mb-1">Lokasi</label><select value={filterPlace} onChange={(e) => setFilterPlace(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500"><option value="">Semua Lokasi</option>{combinedLocations.map((loc, idx) => <option key={idx} value={loc.name || loc}>{loc.name || loc}</option>)}</select></div>
                            <div><label className="block text-xs font-semibold text-slate-500 mb-1">Perkara</label><select value={filterType} onChange={(e) => setFilterType(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500"><option value="">Semua Perkara</option>{combinedActivityTypes.map((type, idx) => <option key={idx} value={type.name || type}>{type.name || type}</option>)}</select></div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-slate-100 pt-4">
                            <button onClick={() => downloadCSV(filteredLogs, `Laporan_Admin_${selectedMonth}.csv`)} className="flex items-center justify-center space-x-2 bg-green-600 text-white p-3 rounded-lg shadow-sm hover:bg-green-700 transition-colors"><Icons.FileSpreadsheet className="w-5 h-5" /><div className="text-left"><div className="font-bold text-sm">Muat Turun Excel (CSV)</div></div></button>
                            <button onClick={() => window.print()} className="flex items-center justify-center space-x-2 bg-slate-700 text-white p-3 rounded-lg shadow-sm hover:bg-slate-800 transition-colors"><Icons.Printer className="w-5 h-5" /><div className="text-left"><div className="font-bold text-sm">Cetak / Simpan PDF</div></div></button>
                        </div>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden print:shadow-none print:border-none">
                        <div className="p-4 bg-slate-50 border-b border-slate-100 font-semibold text-slate-700 flex justify-between items-center"><span>Pratonton Laporan: {selectedMonth}</span><span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">{filteredLogs.length} Rekod Dijumpai</span></div>
                        <div className="overflow-x-auto"><table className="w-full text-sm text-left text-slate-600"><thead className="bg-slate-50 text-xs uppercase text-slate-500"><tr><th className="px-4 py-3">Tarikh</th><th className="px-4 py-3">Nama Pegawai</th><th className="px-4 py-3">Tempat</th><th className="px-4 py-3">Perkara</th><th className="px-4 py-3">Catatan</th></tr></thead><tbody>{filteredLogs.length > 0 ? filteredLogs.map((log) => (<tr key={log.id} className="border-b hover:bg-slate-50"><td className="px-4 py-3">{formatDate(log.date)}</td><td className="px-4 py-3 font-medium">{log.userName}</td><td className="px-4 py-3">{log.location}</td><td className="px-4 py-3">{log.type}</td><td className="px-4 py-3 italic">{log.catatan || '-'}</td></tr>)) : (<tr><td colSpan="5" className="px-4 py-8 text-center text-slate-400">Tiada rekod untuk padanan ini.</td></tr>)}</tbody></table></div>
                    </div>
                </div>
            );
        };

        const AdminDashboard = ({ user, logs, data, allUsers, combinedLocations, combinedActivityTypes, onUpdateData }) => {
            const [activeTab, setActiveTab] = useState('data');

            // Simulated CRUD Handlers for Data Management Tab
            const onAddLocation = (name, category) => { 
                const newId = (data.locations.length + 1).toString();
                onUpdateData('locations', [...data.locations, {id: newId, name, category }]);
                alert(`Lokasi '${name}' ditambah (Demo).`);
            };
            const onDeleteLocation = (id) => { 
                onUpdateData('locations', data.locations.filter(l => l.id !== id));
                alert(`Lokasi ID ${id} dipadam (Demo).`);
            };
            const onAddActivity = (name) => {
                const newId = (data.activityTypes.length + 1).toString();
                onUpdateData('activityTypes', [...data.activityTypes, {id: newId, name }]);
                alert(`Perkara '${name}' ditambah (Demo).`);
            };
            const onDeleteActivity = (id) => {
                onUpdateData('activityTypes', data.activityTypes.filter(t => t.id !== id));
                alert(`Perkara ID ${id} dipadam (Demo).`);
            };
            const onDeleteUser = (id) => {
                onUpdateData('users', data.users.filter(u => u.id !== id));
                alert(`Pengguna ID ${id} dipadam (Demo).`);
            };
            const onResetUserPassword = (id, newPw) => {
                onUpdateData('users', data.users.map(u => u.id === id ? {...u, password: newPw } : u));
                alert(`Kata laluan pengguna ID ${id} diset semula (Demo).`);
            };
            const onDeleteLog = (id) => {
                const idsToDelete = Array.isArray(id) ? id : [id];
                onUpdateData('logs', logs.filter(l => !idsToDelete.includes(l.id)));
                alert(`Rekod log ID(s) ${idsToDelete.join(', ')} dipadam (Demo).`);
            };


            return (
                <div className="p-6 lg:p-10 flex-1 max-w-7xl mx-auto">
                    <h1 className="text-2xl font-bold text-slate-800 mb-2">Paparan Utama Admin</h1>
                    <p className="text-slate-500 mb-6">Urus sistem E-Gerak PPD Ranau.</p>
                    <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 border-b border-slate-200 mb-6 overflow-x-auto hide-scroll">
                        <button onClick={() => setActiveTab('data')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 whitespace-nowrap ${activeTab === 'data' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500'}`}><span className="flex items-center space-x-2"><Icons.Settings className="w-4 h-4"/> <span>1. Pengurusan Data</span></span></button>
                        <button onClick={() => setActiveTab('analisis')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 whitespace-nowrap ${activeTab === 'analisis' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500'}`}><span className="flex items-center space-x-2"><Icons.Filter className="w-4 h-4"/> <span>2. Analisis & Rekod</span></span></button>
                        <button onClick={() => setActiveTab('stats')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 whitespace-nowrap ${activeTab === 'stats' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500'}`}><span className="flex items-center space-x-2"><Icons.PieChart className="w-4 h-4"/> <span>3. Statistik</span></span></button>
                        <button onClick={() => setActiveTab('leaderboard')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 whitespace-nowrap ${activeTab === 'leaderboard' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500'}`}><span className="flex items-center space-x-2"><Icons.Trophy className="w-4 h-4"/> <span>4. Leaderboard</span></span></button>
                        <button onClick={() => setActiveTab('laporan')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 whitespace-nowrap ${activeTab === 'laporan' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500'}`}><span className="flex items-center space-x-2"><Icons.FileText className="w-4 h-4"/> <span>5. Laporan Bulanan</span></span></button>
                    </div>
                    <div className="min-h-[500px]">
                        {activeTab === 'data' && (<AdminDataManagementTab locations={data.locations} activityTypes={data.activityTypes} users={data.users} logs={logs} onAddLocation={onAddLocation} onDeleteLocation={onDeleteLocation} onAddActivity={onAddActivity} onDeleteActivity={onDeleteActivity} onDeleteUser={onDeleteUser} onResetUserPassword={onResetUserPassword} />)}
                        {activeTab === 'analisis' && (<AdminAnalysisTab logs={logs} allUsers={allUsers} combinedLocations={combinedLocations} combinedActivityTypes={combinedActivityTypes} onDeleteLog={onDeleteLog} />)}
                        {activeTab === 'stats' && (<AdminStatsTab logs={logs} allUsers={allUsers} combinedLocations={combinedLocations} combinedActivityTypes={combinedActivityTypes} />)}
                        {activeTab === 'leaderboard' && <AdminLeaderboardTab logs={logs} allUsers={allUsers} />}
                        {activeTab === 'laporan' && (<AdminReportTab logs={logs} allUsers={allUsers} combinedLocations={combinedLocations} combinedActivityTypes={combinedActivityTypes} />)}
                    </div>
                </div>
            );
        };


        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [error, setError] = useState('');
            const [usersLoading, setUsersLoading] = useState(true);
            const [users, setUsers] = useState(INITIAL_DATA.users); 
            const [logs, setLogs] = useState(INITIAL_DATA.logs);
            const [locations, setLocations] = useState(INITIAL_DATA.locations);
            const [activityTypes, setActivityTypes] = useState(INITIAL_DATA.activityTypes);
            const [showSuccessModal, setShowSuccessModal] = useState(false);
            
            // --- FIREBASE/AUTH/LOADING SIMULATION ---
            useEffect(() => {
                // Simulating initialization and anonymous sign-in
                // In a real environment, this would await signInWithCustomToken(__initial_auth_token)
                auth.signInAnonymously().then(() => setUsersLoading(false)).catch(() => setUsersLoading(false));
                
                // Simulating user data loading complete (just in case firebase takes time)
                setTimeout(() => setUsersLoading(false), 500); 
            }, []);

            // Function for admin data manipulation (for demo purposes)
            const updateDataState = (key, newData) => {
                if (key === 'users') setUsers(newData);
                else if (key === 'logs') setLogs(newData);
                else if (key === 'locations') setLocations(newData);
                else if (key === 'activityTypes') setActivityTypes(newData);
            };

            // --- COMPUTED DATA (Must match original logic) ---
            const combinedLocations = useMemo(() => {
                const masterMap = new Map(locations.map(l => [l.name, l]));
                logs.forEach(l => { 
                    if (l.location && !masterMap.has(l.location)) { 
                        masterMap.set(l.location, { name: l.location, category: 'Lain-Lain Tempat' }); 
                    } 
                });
                return Array.from(masterMap.values()).sort((a,b) => (a.name || '').localeCompare(b.name || ''));
            }, [logs, locations]);
            
            const combinedActivityTypes = useMemo(() => {
                const logTypes = logs.map(l => l.type).filter(Boolean);
                const masterTypes = activityTypes.map(l => l.name || l);
                return Array.from(new Set([...masterTypes, ...logTypes])).sort();
            }, [logs, activityTypes]);
            
            const allUsers = useMemo(() => {
                const logUserNames = logs.map(l => l.userName).filter(Boolean);
                const registeredUserNames = users.map(u => u.name).filter(Boolean);
                return Array.from(new Set([...registeredUserNames, ...logUserNames])).sort();
            }, [logs, users]);


            // --- AUTH/DATA HANDLERS ---
            const handleLogin = (username, password, role) => {
                // This compares the provided username/password/role against the in-memory users list
                let foundUser = users.find(u => u.username.toLowerCase() === username.toLowerCase() && u.password === password && u.role === role);
                
                if (foundUser) { 
                    // Simulate updating lastSeen status on login
                    setUser({...foundUser, lastSeen: new Date()});
                    setUsers(prevUsers => prevUsers.map(u => u.id === foundUser.id ? {...u, lastSeen: new Date()} : u));
                    setError(''); 
                } else { 
                    setError('ID Pengguna atau Kata Laluan tidak sah.'); 
                }
            };
            const handleRegister = (newUser) => {
                const id = (users.length + 1).toString();
                setUsers([...users, { ...newUser, id }]);
                setShowSuccessModal(true);
                // alert('Pendaftaran berjaya (Mod Demo)! Sila log masuk.');
            };

            const handleLogout = () => { 
                setUser(null); 
                setError('');
                auth.signOut().catch(() => {});
            };

            const handleAddLog = (newLogData) => {
                // Logic to infer/add custom locations to master list for persistence across sessions
                if (newLogData.category === 'Lain-Lain Tempat' && !locations.some(l => l.name === newLogData.location)) {
                    const newLocId = (locations.length + 1).toString();
                    setLocations(prev => [...prev, { id: newLocId, name: newLogData.location, category: 'Lain-Lain Tempat' }]);
                }
                
                const newEntry = { 
                    id: Date.now().toString(), 
                    userId: user.id || 'temp', 
                    userName: user.name, 
                    date: newLogData.date, 
                    location: newLogData.location, 
                    type: newLogData.type, 
                    catatan: newLogData.catatan, 
                    createdAt: new Date().toISOString() // Store ISO string for easier sorting/comparison
                };
                setLogs([newEntry, ...logs]);
                setShowSuccessModal(true);
            };

            const relevantLogs = user ? (user.role === 'admin' ? logs : logs.filter(log => log.userId === user.id)) : [];
            const dashboardData = { users, logs, locations, activityTypes };


            if (usersLoading) return <div className="h-screen flex items-center justify-center text-blue-900"><Icons.RefreshCw className="animate-spin w-8 h-8"/></div>;

            if (!user) {
                return <LoginPage onLogin={handleLogin} onRegister={handleRegister} error={error} usersLoading={usersLoading} />;
            }

            return (
                <div className="min-h-screen bg-slate-50 flex font-sans">
                    <aside className="hidden md:flex flex-col w-64 bg-blue-900 text-white fixed h-full z-10 print:hidden">
                        <div className="p-6 flex items-center space-x-3 border-b border-blue-800">
                            <div className="bg-white p-1 rounded-full"><Icons.MapPin className="w-6 h-6 text-blue-900" /></div>
                            <span className="font-bold text-lg tracking-wide">E-Gerak</span>
                        </div>
                        <div className="flex-1 p-4">
                            <div className="p-4 bg-blue-800 rounded-xl mb-4">
                                <p className="text-xs text-blue-300 uppercase tracking-wider mb-1">Akaun</p>
                                <p className="font-bold truncate">{user.name}</p>
                                <p className="text-xs text-blue-200">{user.role === 'admin' ? 'Pentadbir Sistem' : 'Pegawai / Staf'}</p>
                            </div>
                        </div>
                        <div className="p-4 border-t border-blue-800">
                            <button onClick={handleLogout} className="flex items-center space-x-2 text-sm text-blue-200 hover:text-white w-full px-2 py-2 rounded-lg hover:bg-blue-800 transition-colors">
                                <Icons.Lock className="w-4 h-4" /><span>Log Keluar</span>
                            </button>
                        </div>
                    </aside>
                    <main className="flex-1 md:ml-64 flex flex-col min-h-screen">
                         <header className="bg-white shadow-sm sticky top-0 z-20 md:hidden px-4 py-3 flex justify-between items-center print:hidden">
                            <div className="flex items-center space-x-2"><Icons.MapPin className="text-blue-900 w-6 h-6" /><span className="font-bold text-blue-900">E-Gerak</span></div>
                            <button onClick={handleLogout} className="text-red-500 text-sm font-semibold">Log Keluar</button>
                         </header>
                         {user.role === 'staff' ? (
                            <StaffDashboard 
                                user={user} 
                                logs={relevantLogs} 
                                onAddLog={handleAddLog} 
                                combinedLocations={combinedLocations} 
                                combinedActivityTypes={combinedActivityTypes} 
                            />
                        ) : (
                            <AdminDashboard 
                                user={user} 
                                logs={logs} 
                                data={dashboardData}
                                allUsers={allUsers} 
                                combinedLocations={combinedLocations} 
                                combinedActivityTypes={combinedActivityTypes}
                                onUpdateData={updateDataState}
                            />
                        )}
                    </main>
                    <SuccessModal isOpen={showSuccessModal} onClose={() => setShowSuccessModal(false)} message="Laporan telah dihantar." />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>