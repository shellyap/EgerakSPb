<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E-Gerak Tracker PPD Ranau</title>
    
    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        body { overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-green { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(74, 222, 128, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); } }
        .online-dot { width: 8px; height: 8px; background-color: #22c55e; border-radius: 50%; animation: pulse-green 2s infinite; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 select-none">
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. KONFIGURASI ---
        const LOGO_URL = "https://upload.wikimedia.org/wikipedia/commons/thumb/2/26/Coat_of_arms_of_Malaysia.svg/1200px-Coat_of_arms_of_Malaysia.svg.png"; 
        
        // *** MASUKKAN FIREBASE CONFIG ANDA DI SINI ***
        const firebaseConfig = {
            apiKey: "AIzaSyBU1n6OAmYxY_SjFuhYkop7C7CrFJja6Do",
            authDomain: "egerak-4f922.firebaseapp.com",
            projectId: "egerak-4f922",
            storageBucket: "egerak-4f922.firebasestorage.app",
            messagingSenderId: "567427021114",
            appId: "1:567427021114:web:cf5496d2fc14eb84893803",
            measurementId: "G-V6CGGJ81JG"
        };

        if (!firebase.apps.length) { try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error(e); } }
        const db = firebase.apps.length ? firebase.firestore() : null;
        const auth = firebase.apps.length ? firebase.auth() : null;

        const LOCATION_CATEGORIES = ['Sekolah Rendah', 'Sekolah Menengah', 'Lain-Lain Tempat'];
        const INITIAL_DATA = {
            users: [{ id: '1', username: 'shell', password: 'shellyap', role: 'admin', name: 'Shell Yap', department: 'IT' }],
            logs: [],
            locations: [], 
            activityTypes: []
        };

        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS (FIXED SYNTAX) ---
        // Modified Icon component to accept children instead of just 'd' prop for complex icons
        const Icon = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Icons = {
            MapPin: (p) => <Icon {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></Icon>,
            User: (p) => <Icon {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Icon>,
            LogOut: (p) => <Icon {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></Icon>,
            Plus: (p) => <Icon {...p}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>,
            Filter: (p) => <Icon {...p}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></Icon>,
            FileText: (p) => <Icon {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></Icon>,
            CheckCircle: (p) => <Icon {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>,
            Trash2: (p) => <Icon {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>,
            AlertCircle: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></Icon>,
            Calendar: (p) => <Icon {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></Icon>,
            PieChart: (p) => <Icon {...p}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></Icon>,
            Settings: (p) => <Icon {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>,
            Trophy: (p) => <Icon {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 1 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></Icon>, 
            RefreshCw: (p) => <Icon {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></Icon>,
            List: (p) => <Icon {...p}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></Icon>,
            TrendingUp: (p) => <Icon {...p}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></Icon>,
            ChevronDown: (p) => <Icon {...p}><path d="m6 9 6 6 6-6"/></Icon>,
            X: (p) => <Icon {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>,
            Key: (p) => <Icon {...p}><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/></Icon>,
            Edit3: (p) => <Icon {...p}><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></Icon>,
            Info: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></Icon>,
            AlertTriangle: (p) => <Icon {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></Icon>,
            Printer: (p) => <Icon {...p}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></Icon>,
            FileSpreadsheet: (p) => <Icon {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></Icon>,
            Menu: (p) => <Icon {...p}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></Icon>,
            UsersIcon: (p) => <Icon {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Icon>
        };

        // --- UTILS ---
        const formatDate = (ds) => { if(!ds) return '-'; const [y,m,d] = ds.split('-'); return `${d}/${m}/${y.slice(-2)}`; };
        const isUserOnline = (ls) => { if(!ls) return false; const d = ls.toDate ? ls.toDate() : new Date(ls); return d > new Date(Date.now() - 5*60000); };
        
        const downloadCSV = (data, filename) => {
            const headers = ["Tarikh", "Nama", "Tujuan", "Lokasi", "Catatan"];
            const rows = data.map(row => [formatDate(row.date), row.userName, row.type, row.location, (row.catatan || '').replace(/,/g, ' ')]);
            const csv = "data:text/csv;charset=utf-8," + [headers.join(","), ...rows.map(e => e.join(","))].join("\n");
            const link = document.createElement("a"); link.href = encodeURI(csv); link.download = filename; document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        // --- COMPONENTS ---

        const SearchableLocationSelect = ({ options, value, onChange, placeholder }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const wrapperRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (e) => { if (wrapperRef.current && !wrapperRef.current.contains(e.target)) setIsOpen(false); };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            useEffect(() => { if(value && !searchTerm) setSearchTerm(value); }, [value]);

            const groupedOptions = useMemo(() => {
                const groups = { 'Sekolah Rendah': [], 'Sekolah Menengah': [], 'Lain-Lain Tempat': [] };
                options.forEach(opt => {
                    const name = opt.name || opt;
                    const cat = opt.category || 'Lain-Lain Tempat';
                    if(name.toLowerCase().includes(searchTerm.toLowerCase())) {
                        if(groups[cat]) groups[cat].push(name);
                        else groups['Lain-Lain Tempat'].push(name);
                    }
                });
                return groups;
            }, [options, searchTerm]);

            const handleSelect = (name) => { setSearchTerm(name); onChange(name); setIsOpen(false); };

            return (
                <div className="relative" ref={wrapperRef}>
                    <div className="relative">
                        <input type="text" className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder={placeholder} value={searchTerm} onChange={(e) => { setSearchTerm(e.target.value); setIsOpen(true); onChange(e.target.value); }} onFocus={() => setIsOpen(true)} />
                        <div className="absolute right-3 top-3 text-slate-400 pointer-events-none">{isOpen ? <Icons.X className="w-4 h-4"/> : <Icons.ChevronDown className="w-4 h-4"/>}</div>
                    </div>
                    {isOpen && searchTerm && (
                        <div className="absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar">
                            {Object.entries(groupedOptions).map(([cat, items]) => items.length > 0 && (
                                <div key={cat}>
                                    <div className="px-3 py-1.5 bg-slate-100 text-xs font-bold text-slate-500 uppercase sticky top-0">{cat}</div>
                                    {items.map(item => <div key={item} className="px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 cursor-pointer" onClick={() => handleSelect(item)}>{item}</div>)}
                                </div>
                            ))}
                            {Object.values(groupedOptions).every(a => a.length === 0) && <div className="px-4 py-3 text-sm text-slate-400 italic text-center">Tiada padanan.</div>}
                        </div>
                    )}
                </div>
            );
        };

        const Modal = ({ isOpen, onClose, children }) => {
            if (!isOpen) return null;
            return <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[150] p-4 fade-in"><div className="bg-white rounded-xl max-w-sm w-full p-6 shadow-2xl transform scale-100 transition-transform">{children}</div></div>;
        };

        const SuccessModal = ({ isOpen, onClose }) => (
            <Modal isOpen={isOpen} onClose={onClose}>
                <div className="text-center">
                    <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.CheckCircle className="w-8 h-8 text-green-600" /></div>
                    <h3 className="text-xl font-bold text-slate-800 mb-2">Berjaya!</h3>
                    <button onClick={onClose} className="w-full bg-blue-900 text-white py-2.5 rounded-lg font-bold">Tutup</button>
                </div>
            </Modal>
        );

        const DeleteModal = ({ isOpen, onClose, onConfirm, text }) => (
            <Modal isOpen={isOpen} onClose={onClose}>
                <div className="text-center">
                    <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse"><Icons.Trash2 className="w-8 h-8 text-red-600" /></div>
                    <h3 className="text-xl font-bold text-slate-800 mb-2">Pengesahan</h3>
                    <p className="text-slate-600 mb-6 text-sm">{text}</p>
                    <div className="flex space-x-3"><button onClick={onClose} className="flex-1 bg-slate-100 py-2.5 rounded-lg font-bold">Batal</button><button onClick={onConfirm} className="flex-1 bg-red-600 text-white py-2.5 rounded-lg font-bold">Ya, Padam</button></div>
                </div>
            </Modal>
        );

        // --- AUTH ---
        const LoginPage = ({ onLogin, onRegister, loading }) => {
            const [isReg, setIsReg] = useState(false);
            const [data, setData] = useState({ username: '', password: '', fullName: '', department: '' });

            const handleSubmit = (e) => { e.preventDefault(); isReg ? onRegister(data) : onLogin(data.username, data.password, 'staff'); };
            
            return (
                <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
                    <div className="max-w-md w-full bg-white rounded-2xl shadow-xl overflow-hidden">
                        <div className="bg-blue-900 p-8 text-center relative">
                            <div className="relative z-10">
                                <div className="w-20 h-20 bg-white rounded-full mx-auto mb-4 flex items-center justify-center p-1"><img src={LOGO_URL} className="w-full h-full object-contain"/></div>
                                <h1 className="text-2xl font-bold text-white">E-Gerak</h1><p className="text-blue-200 text-sm">PPD Ranau</p>
                            </div>
                        </div>
                        <div className="p-8">
                            {loading ? <div className="text-center py-4"><Icons.RefreshCw className="w-8 h-8 animate-spin mx-auto text-blue-600"/></div> : 
                            <form onSubmit={handleSubmit} className="space-y-4">
                                {!isReg && <div className="flex bg-slate-100 rounded-lg p-1 mb-4"><button type="button" onClick={() => onLogin(data.username, data.password, 'staff')} className="flex-1 py-2 text-sm font-bold text-blue-900 bg-white shadow-sm rounded">Log Masuk</button></div>}
                                {isReg && <><input type="text" required placeholder="Nama Penuh" value={data.fullName} onChange={e=>setData({...data, fullName:e.target.value.toUpperCase()})} className="w-full border p-3 rounded-lg"/><input type="text" required placeholder="Unit / Sekolah" value={data.department} onChange={e=>setData({...data, department:e.target.value})} className="w-full border p-3 rounded-lg"/></>}
                                <input type="text" required placeholder="ID Pengguna" value={data.username} onChange={e=>setData({...data, username:e.target.value})} className="w-full border p-3 rounded-lg"/>
                                <input type="password" required placeholder="Kata Laluan" value={data.password} onChange={e=>setData({...data, password:e.target.value})} className="w-full border p-3 rounded-lg"/>
                                <button type="submit" className="w-full bg-blue-900 text-white py-3 rounded-lg font-bold">{isReg ? 'Daftar' : 'Log Masuk'}</button>
                                <div className="text-center mt-4"><button type="button" onClick={() => setIsReg(!isReg)} className="text-sm text-blue-600 hover:underline">{isReg ? 'Sudah ada akaun? Log Masuk' : 'Pengguna baru? Daftar di sini'}</button></div>
                            </form>}
                        </div>
                    </div>
                </div>
            );
        };

        // --- STAFF ---
        const StaffDashboard = ({ user, logs, onAddLog, locations, types }) => {
            const [tab, setTab] = useState('daftar');
            const [form, setForm] = useState({ date: new Date().toISOString().split('T')[0], location: '', type: '', catatan: '', category: 'Sekolah Rendah' });
            const [isManual, setIsManual] = useState(false);

            // Filter Logic
            const [filter, setFilter] = useState({ date: '', place: '', type: '' });
            const filteredLogs = logs.filter(l => {
                if(!filter.date && !filter.place && !filter.type) return l.date.startsWith(new Date().toISOString().slice(0,7));
                return (filter.date ? l.date === filter.date : true) && (filter.place ? l.location.includes(filter.place) : true);
            });

            // Report Logic
            const [reportMonth, setReportMonth] = useState(new Date().toISOString().slice(0,7));
            const reportLogs = logs.filter(l => l.date.startsWith(reportMonth));

            const filteredLocs = useMemo(() => locations.filter(l => (l.category || 'Lain-Lain Tempat') === form.category), [locations, form.category]);

            return (
                <div className="p-4 max-w-4xl mx-auto pb-20">
                    <div className="mb-6"><h1 className="text-2xl font-bold text-slate-800">Selamat Datang, {user.name}</h1><p className="text-slate-500">{user.department}</p></div>
                    
                    <div className="flex space-x-2 overflow-x-auto pb-2 mb-6 border-b">
                        {['daftar', 'saring', 'laporan'].map(t => (
                            <button key={t} onClick={() => setTab(t)} className={`px-4 py-2 text-sm font-bold capitalize whitespace-nowrap ${tab === t ? 'text-blue-900 border-b-2 border-blue-900' : 'text-slate-400'}`}>{t}</button>
                        ))}
                    </div>

                    {tab === 'daftar' && (
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 fade-in">
                            <div className="flex items-center gap-2 mb-4 text-blue-900 font-bold"><Icons.Plus className="w-5 h-5"/> Daftar Pergerakan</div>
                            <form onSubmit={(e) => { e.preventDefault(); onAddLog(form); setForm({...form, catatan:'', location:''}); setIsManual(false); }} className="space-y-4">
                                <div><label className="text-xs font-bold text-slate-500">Tarikh</label><input type="date" required value={form.date} onChange={e => setForm({...form, date:e.target.value})} className="w-full border p-2.5 rounded-lg"/></div>
                                
                                <div>
                                    <label className="text-xs font-bold text-slate-500">Kategori Tempat</label>
                                    <div className="flex flex-wrap gap-2 mt-1">
                                        {LOCATION_CATEGORIES.map(c => (
                                            <button type="button" key={c} onClick={() => {setForm({...form, category:c, location:''}); setIsManual(false);}} className={`px-3 py-1 text-xs rounded-full border ${form.category === c ? 'bg-blue-600 text-white' : 'bg-slate-50'}`}>{c}</button>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <label className="text-xs font-bold text-slate-500">Lokasi</label>
                                    {isManual ? 
                                        <div className="flex gap-2"><input type="text" required value={form.location} onChange={e => setForm({...form, location:e.target.value})} placeholder="Nama tempat..." className="w-full border p-2.5 rounded-lg bg-blue-50"/><button type="button" onClick={() => setIsManual(false)} className="px-3 border rounded-lg"><Icons.List className="w-5 h-5"/></button></div>
                                    : 
                                        <div className="flex gap-2">
                                            <div className="flex-1"><SearchableLocationSelect options={filteredLocs} value={form.location} onChange={v => setForm({...form, location:v})} placeholder={`Cari di ${form.category}...`}/></div>
                                            {form.category === 'Lain-Lain Tempat' && <button type="button" onClick={() => {setIsManual(true); setForm({...form, location:''})}} className="px-3 bg-blue-50 text-blue-600 text-xs font-bold rounded-lg border border-blue-200">+ Tambah</button>}
                                        </div>
                                    }
                                </div>

                                <div><label className="text-xs font-bold text-slate-500">Tujuan</label><select required value={form.type} onChange={e => setForm({...form, type:e.target.value})} className="w-full border p-2.5 rounded-lg"><option value="">Pilih Tujuan</option>{types.map(t => <option key={t} value={t.name || t}>{t.name || t}</option>)}</select></div>
                                <div><label className="text-xs font-bold text-slate-500">Catatan</label><textarea value={form.catatan} onChange={e => setForm({...form, catatan:e.target.value})} className="w-full border p-2.5 rounded-lg" rows="2"></textarea></div>
                                <button type="submit" className="w-full bg-blue-900 text-white py-3 rounded-lg font-bold shadow-lg">Hantar Laporan</button>
                            </form>
                        </div>
                    )}

                    {tab === 'saring' && (
                        <div className="space-y-4 fade-in">
                            <div className="bg-white p-4 rounded-xl border shadow-sm">
                                <div className="grid grid-cols-2 gap-2">
                                    <input type="date" value={filter.date} onChange={e => setFilter({...filter, date:e.target.value})} className="border p-2 rounded-lg text-sm"/>
                                    <input type="text" placeholder="Cari tempat..." value={filter.place} onChange={e => setFilter({...filter, place:e.target.value})} className="border p-2 rounded-lg text-sm"/>
                                </div>
                                <button onClick={() => setFilter({date:'', place:'', type:''})} className="text-xs text-red-500 mt-2 w-full text-right">Reset Saringan</button>
                            </div>
                            <div className="bg-white rounded-xl border overflow-hidden">
                                <table className="w-full text-sm text-left"><thead className="bg-slate-100 text-xs uppercase"><tr><th className="p-3">Tarikh</th><th className="p-3">Lokasi</th><th className="p-3">Tujuan</th></tr></thead>
                                    <tbody>{filteredLogs.map(l => <tr key={l.id} className="border-b"><td className="p-3">{formatDate(l.date)}</td><td className="p-3">{l.location}</td><td className="p-3">{l.type}</td></tr>)}</tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {tab === 'laporan' && (
                        <div className="space-y-4 fade-in">
                            <div className="bg-white p-4 rounded-xl border shadow-sm flex justify-between items-center">
                                <h3 className="font-bold">Laporan Bulanan</h3>
                                <input type="month" value={reportMonth} onChange={e => setReportMonth(e.target.value)} className="border p-2 rounded-lg text-sm"/>
                            </div>
                            <div className="grid grid-cols-2 gap-2">
                                <button onClick={() => downloadCSV(reportLogs, `Laporan_${reportMonth}.csv`)} className="bg-green-600 text-white p-3 rounded-lg text-center font-bold text-sm">Excel</button>
                                <button onClick={() => window.print()} className="bg-slate-700 text-white p-3 rounded-lg text-center font-bold text-sm">PDF / Print</button>
                            </div>
                             <div className="bg-white rounded-xl border overflow-hidden">
                                <div className="p-3 bg-slate-50 text-xs font-bold border-b">Pratonton: {reportLogs.length} Rekod</div>
                                <table className="w-full text-sm text-left"><thead className="bg-slate-100 text-xs uppercase"><tr><th className="p-3">Tarikh</th><th className="p-3">Lokasi</th><th className="p-3">Tujuan</th></tr></thead>
                                    <tbody>{reportLogs.map(l => <tr key={l.id} className="border-b"><td className="p-3">{formatDate(l.date)}</td><td className="p-3">{l.location}</td><td className="p-3">{l.type}</td></tr>)}</tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- ADMIN DASHBOARD ---
        const AdminDashboard = ({ users, logs, locations, types, actions }) => {
            const [tab, setTab] = useState('data');
            // Shared Filters for Admin
            const [filters, setFilters] = useState({ month: '', staff: '', place: '', type: '' });
            const [bulkDeleteOpen, setBulkDeleteOpen] = useState(false);

            // Admin Data Management State
            const [newLoc, setNewLoc] = useState('');
            const [newCat, setNewCat] = useState('Sekolah Rendah');
            const [newAct, setNewAct] = useState('');
            const [deleteItem, setDeleteItem] = useState(null); // { type, id, name }

            const filteredLogs = logs.filter(l => {
                if (!l.date) return false;
                return (filters.month ? l.date.startsWith(filters.month) : true) &&
                       (filters.staff ? l.userName === filters.staff : true) &&
                       (filters.place ? l.location === filters.place : true) &&
                       (filters.type ? l.type === filters.type : true);
            });

            const handleBulkDelete = () => {
                filteredLogs.forEach(l => actions.deleteLog(l.id));
                setBulkDeleteOpen(false);
            };

            const renderDataTab = () => (
                <div className="grid md:grid-cols-2 gap-6 fade-in">
                    <div className="bg-white p-6 rounded-xl border">
                        <h3 className="font-bold mb-4">Lokasi (Master)</h3>
                        <div className="flex gap-2 mb-2"><input type="text" value={newLoc} onChange={e => setNewLoc(e.target.value)} className="flex-1 border p-2 rounded" placeholder="Nama Lokasi"/><button onClick={() => {actions.addLocation(newLoc, newCat); setNewLoc('');}} className="bg-blue-600 text-white px-3 rounded"><Icons.Plus/></button></div>
                        <select value={newCat} onChange={e => setNewCat(e.target.value)} className="w-full border p-2 mb-4 rounded text-sm">{LOCATION_CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}</select>
                        <div className="max-h-60 overflow-y-auto">{locations.map(l => <div key={l.id} className="flex justify-between items-center p-2 border-b text-sm"><span>{l.name} <span className="text-xs text-gray-400">({l.category})</span></span><button onClick={() => setDeleteItem({type:'loc', id:l.id, name:l.name})} className="text-red-500"><Icons.Trash2/></button></div>)}</div>
                    </div>
                    <div className="bg-white p-6 rounded-xl border">
                        <h3 className="font-bold mb-4">Perkara (Master)</h3>
                        <div className="flex gap-2 mb-4"><input type="text" value={newAct} onChange={e => setNewAct(e.target.value)} className="flex-1 border p-2 rounded" placeholder="Aktiviti"/><button onClick={() => {actions.addActivity(newAct); setNewAct('');}} className="bg-blue-600 text-white px-3 rounded"><Icons.Plus/></button></div>
                        <div className="max-h-60 overflow-y-auto">{types.map(t => <div key={t.id} className="flex justify-between items-center p-2 border-b text-sm"><span>{t.name}</span><button onClick={() => setDeleteItem({type:'act', id:t.id, name:t.name})} className="text-red-500"><Icons.Trash2/></button></div>)}</div>
                    </div>
                </div>
            );

            const renderAnalysisTab = () => (
                 <div className="space-y-4 fade-in">
                    <div className="bg-white p-4 rounded-xl border">
                        <div className="flex justify-between mb-4"><h3 className="font-bold flex gap-2"><Icons.Filter/> Filter</h3>{filteredLogs.length > 0 && <button onClick={() => setBulkDeleteOpen(true)} className="text-xs bg-red-600 text-white px-3 py-1 rounded">Kosongkan Rekod</button>}</div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <input type="month" value={filters.month} onChange={e => setFilters({...filters, month:e.target.value})} className="border p-2 rounded text-sm"/>
                            <select value={filters.staff} onChange={e => setFilters({...filters, staff:e.target.value})} className="border p-2 rounded text-sm"><option value="">Semua Staf</option>{users.map(u => <option key={u.id} value={u.name}>{u.name}</option>)}</select>
                            <select value={filters.place} onChange={e => setFilters({...filters, place:e.target.value})} className="border p-2 rounded text-sm"><option value="">Semua Lokasi</option>{locations.map(l => <option key={l.id} value={l.name}>{l.name}</option>)}</select>
                            <select value={filters.type} onChange={e => setFilters({...filters, type:e.target.value})} className="border p-2 rounded text-sm"><option value="">Semua Perkara</option>{types.map(t => <option key={t.id} value={t.name}>{t.name}</option>)}</select>
                        </div>
                        <button onClick={() => setFilters({month:'', staff:'', place:'', type:''})} className="text-xs text-blue-600 mt-2 underline">Reset Filter</button>
                    </div>
                    <div className="bg-white rounded-xl border overflow-hidden">
                        <table className="w-full text-sm text-left"><thead className="bg-slate-50 uppercase text-xs"><tr><th className="p-3">Tarikh</th><th className="p-3">Nama</th><th className="p-3">Lokasi</th><th className="p-3">Perkara</th><th className="p-3 text-right">Aksi</th></tr></thead>
                        <tbody>{filteredLogs.map(l => <tr key={l.id} className="border-b"><td className="p-3">{formatDate(l.date)}</td><td className="p-3 font-bold">{l.userName}</td><td className="p-3">{l.location}</td><td className="p-3">{l.type}</td><td className="p-3 text-right"><button onClick={() => setDeleteItem({type:'log', id:l.id, name:'Log Ini'})} className="text-red-500"><Icons.Trash2/></button></td></tr>)}</tbody></table>
                    </div>
                 </div>
            );

            return (
                <div className="p-6 max-w-6xl mx-auto">
                    <h1 className="text-2xl font-bold text-slate-800 mb-6">Admin Dashboard</h1>
                    <div className="flex space-x-4 border-b mb-6 overflow-x-auto">
                        {['data', 'analisis'].map(t => <button key={t} onClick={() => setTab(t)} className={`pb-2 capitalize font-bold ${tab === t ? 'text-blue-900 border-b-2 border-blue-900' : 'text-slate-400'}`}>{t}</button>)}
                    </div>
                    {tab === 'data' && renderDataTab()}
                    {tab === 'analisis' && renderAnalysisTab()}
                    
                    <DeleteConfirmationModal isOpen={!!deleteItem} onClose={() => setDeleteItem(null)} onConfirm={() => { 
                        if(deleteItem.type === 'loc') actions.deleteLocation(deleteItem.id);
                        if(deleteItem.type === 'act') actions.deleteActivity(deleteItem.id);
                        if(deleteItem.type === 'log') actions.deleteLog(deleteItem.id);
                        setDeleteItem(null); 
                    }} itemName={deleteItem?.name} />
                    <BulkDeleteModal isOpen={bulkDeleteOpen} onClose={() => setBulkDeleteOpen(false)} onConfirm={handleBulkDelete} count={filteredLogs.length} />
                </div>
            );
        };

        // --- APP UTAMA ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            
            // Data State
            const [users, setUsers] = useState(INITIAL_DATA.users);
            const [logs, setLogs] = useState(INITIAL_DATA.logs);
            const [locations, setLocations] = useState(INITIAL_DATA.locations);
            const [types, setTypes] = useState(INITIAL_DATA.activityTypes);

            // Sync
            useEffect(() => {
                if(!db) { setLoading(false); return; }
                auth.signInAnonymously().then(() => {
                    const un1 = db.collection('egerak_users').onSnapshot(s => setUsers(s.docs.map(d => ({id:d.id, ...d.data()}))), () => setLoading(false));
                    const un2 = db.collection('egerak_logs').orderBy('date', 'desc').onSnapshot(s => setLogs(s.docs.map(d => ({id:d.id, ...d.data()}))));
                    const un3 = db.collection('egerak_locations').onSnapshot(s => setLocations(s.docs.map(d => ({id:d.id, ...d.data()}))));
                    const un4 = db.collection('egerak_activities').onSnapshot(s => setTypes(s.docs.map(d => ({id:d.id, ...d.data()}))));
                    setLoading(false);
                });
            }, []);

            // Actions
            const actions = {
                addLog: (d) => {
                    const newLog = { ...d, userId: user.id, userName: user.name, createdAt: new Date() };
                    if(db) {
                        db.collection('egerak_logs').add(newLog);
                        // Auto-add location if custom
                        if(!locations.find(l => l.name === d.location)) {
                             db.collection('egerak_locations').add({ name: d.location, category: d.category });
                        }
                    } else {
                        setLogs([{id: Date.now(), ...newLog}, ...logs]);
                    }
                    alert("Laporan berjaya dihantar!");
                },
                deleteLog: (id) => db ? db.collection('egerak_logs').doc(id).delete() : setLogs(logs.filter(l => l.id !== id)),
                addLocation: (name, cat) => db ? db.collection('egerak_locations').add({name, category: cat}) : setLocations([...locations, {id:Date.now(), name, category:cat}]),
                deleteLocation: (id) => db ? db.collection('egerak_locations').doc(id).delete() : setLocations(locations.filter(l => l.id !== id)),
                addActivity: (name) => db ? db.collection('egerak_activities').add({name}) : setTypes([...types, {id:Date.now(), name}]),
                deleteActivity: (id) => db ? db.collection('egerak_activities').doc(id).delete() : setTypes(types.filter(t => t.id !== id)),
            };

            const handleLogin = (u, p, role) => {
                let found = users.find(x => x.username.toLowerCase() === u.toLowerCase() && x.password === p);
                if(!found && u.toLowerCase() === 'shell' && p === 'shellyap') found = { id:'admin', name:'Shell Yap', role:'admin', department:'IT' };
                
                if(found) setUser(found);
                else alert('ID atau Kata Laluan salah.');
            };

            if(!user) return <LoginPage onLogin={handleLogin} onRegister={(d) => { 
                if(db) db.collection('egerak_users').add(d).then(() => alert('Berjaya daftar!')); 
                else setUsers([...users, d]);
            }} loading={loading} />;

            return (
                <div className="min-h-screen bg-slate-50">
                    {user.role === 'staff' ? 
                        <StaffDashboard user={user} logs={user.role === 'admin' ? logs : logs.filter(l => l.userId === user.id)} onAddLog={actions.addLog} locations={locations} types={types}/> 
                        : 
                        <AdminDashboard user={user} logs={logs} locations={locations} types={types} users={users} actions={actions}/>
                    }
                    <button onClick={() => setUser(null)} className="fixed bottom-4 right-4 bg-red-600 text-white p-3 rounded-full shadow-lg z-50"><Icons.LogOut/></button>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>